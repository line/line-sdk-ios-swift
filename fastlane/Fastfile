default_platform(:ios)

platform :ios do

  before_all do
    begin
        xcversion(version: "~> 11.0")
    rescue => ex
        UI.error("Failed when switching to Xcode version: #{ex}")
    end
  end

  desc "Switch to Beta environment"
  lane :to_beta do
    Action.sh("ruby ../script/to_beta.rb")
  end

  desc "Run tests."
  lane :tests do
    sdk_tests
    sample_tests
  end

  lane :sdk_tests do
    swift_version = ENV["SWIFT_VERSION"] || "4.2"
    run_tests(
        workspace: "LineSDK.xcworkspace",
        devices: ["iPhone 6s"],
        scheme: "LineSDK",
        xcargs: "SWIFT_VERSION=#{swift_version}"
    )
    
    run_tests(
        workspace: "LineSDK.xcworkspace",
        devices: ["iPhone 6s"],
        scheme: "LineSDKObjC",
        xcargs: "SWIFT_VERSION=#{swift_version}"
    )
  end

  lane :sample_tests do
    run_tests(
        workspace: "LineSDK.xcworkspace",
        devices: ["iPhone 6s"],
        scheme: "LineSDKSample"
    )
  end

  desc "Lint to check Carthage and CocoaPods compatibility."
  lane :lint do
    lint_carthage
    lint_pod
  end

  lane :lint_pod do
    swift_version = ENV["SWIFT_VERSION"] || "4.2"
    Action.sh("bundle exec pod lib lint ../LineSDKSwift.podspec --swift-version=#{swift_version}")
  end

  lane :lint_carthage do
    carthage(command: "build", no_skip_current: true)
  end

  desc "Release a new version."
  lane :release do |options|
    target_version = options[:version]
    raise "The version is missed. Use `fastlane release version:{version_number}`.`" if target_version.nil?

    ensure_git_branch
    ensure_git_status_clean

    tests
    lint

    increment_build_number(
        build_number: number_of_commits,
        xcodeproj: "LineSDK/LineSDK.xcodeproj"
    )
    increment_version_number(
        version_number: target_version,
        xcodeproj: "LineSDK/LineSDK.xcodeproj"
    )

    bump_constant_version(version: target_version)
    bump_reference_top_version(version: target_version)
    version_bump_podspec(path: "LineSDKSwift.podspec", version_number: target_version)
    
    release_content = read_changelog(excluded_markdown_elements: [])
    change_log(version: target_version)
    
    xcframework(version: target_version)

    git_commit_all(message: "Bump version to #{target_version}")
    Actions.sh("git tag -u #{ENV["GPG_KEY_ID"]} #{target_version} -m ''")
    
    push_to_git_remote
    set_github_release(
      repository_name: "line/line-sdk-ios-swift",
      api_token: ENV["GITHUB_TOKEN"],
      name: target_version,
      tag_name: target_version,
      description: release_content,
      upload_assets: ["build/LineSDK-#{target_version}.zip", "build/LineSDKObjC-#{target_version}.zip"]
    )

    pod_push
  end

  desc "Generate documentation"
  lane :doc do
    copyright = "jazzy --copyright 'Â© " + Time.new.year.to_s + " [LINE Corporation.](https://line.me) All rights reserved.'"
    Actions.sh(copyright)
  end

  desc "Generate documentation for internal usage"
  lane :doc_internal do
    jazzy(config: ".jazzy-internal.yaml")
  end

  lane :change_log do |options|
    target_version = options[:version]
    raise "The version is missed. You need to specify a version parameter." if target_version.nil?
    stamp_changelog(section_identifier: target_version, git_tag: target_version)
  end

  lane :ensure_latest_carthage do
    Actions.sh("brew update")
    Actions.sh("brew outdated carthage || brew upgrade carthage")
  end

  lane :bump_constant_version do |options|
    target_version = options[:version]
    replacing = "public static let SDKVersion = \"#{target_version}\""
    regex = "public static let SDKVersion = .*"
    constant_file = "../LineSDK/LineSDK/Utils/Constant.swift"
    Action.sh("sed -e 's/#{regex}/#{replacing}/g' #{constant_file} | tee #{constant_file}")
  end

  lane :bump_reference_top_version do |options|
    target_version = options[:version]
    target_version_to_minor = target_version.split(".")[0...-1].join(".")
    lines = File.readlines("../REFERENCETOP.md")
    lines[0] = "# LINE SDK v#{target_version_to_minor} for iOS Swift\n"
    File.open("../REFERENCETOP.md", "w") { |f| f.write(lines.join) }
  end

  desc "Create binary frameworks with the `xcframework` format under the `build/` folder."
  lane :xcframework do |options|
    version = options[:version]
    target_version = "LineSDK-#{version}"
    xcversion(version: "~> 11.0")
    FileUtils.rm_rf '../build'

    # Enable the binary framework schemes (this helps not building it for Carthage)
    FileUtils.mv(
        "../LineSDK/LineSDK.xcodeproj/xcshareddata/xcschemes/LineSDKObjCBinary.xcscheme.bak",
        "../LineSDK/LineSDK.xcodeproj/xcshareddata/xcschemes/LineSDKObjCBinary.xcscheme"
    )
    FileUtils.mv(
        "../LineSDK/LineSDK.xcodeproj/xcshareddata/xcschemes/LineSDKBinary.xcscheme.bak",
        "../LineSDK/LineSDK.xcodeproj/xcshareddata/xcschemes/LineSDKBinary.xcscheme"
    )

    begin
        ["LineSDK", "LineSDKObjC"].each do |scheme|

            artifact_root = "../build/#{target_version}/#{scheme}"
            supporting_root = "#{artifact_root}/Supporting Files"

            frameworks = []

            ["iphoneos", "iphonesimulator"].each do |sdk|
                archive_path = "build/#{scheme} #{sdk}.xcarchive"
                xcodebuild(
                    archive: true, 
                    archive_path: archive_path,
                    scheme: "#{scheme}Binary", 
                    sdk: sdk
                )
                frameworks.push("#{archive_path}/Products/Library/Frameworks/LineSDK.framework")

                dSYM_path = "../#{archive_path}/dSYMs/LineSDK.framework.dSYM"
                FileUtils.mkdir_p("#{supporting_root}/dSYMs/")
                FileUtils.cp_r(dSYM_path, "#{supporting_root}/dSYMs/#{scheme}-#{sdk}.framework.dSYM")

                bitcode_symbol_map_path = "../#{archive_path}/BCSymbolMaps/"
                if Dir.exist?(bitcode_symbol_map_path)
                    FileUtils.mkdir_p("#{supporting_root}/BCSymbolMaps/")
                    FileUtils.cp_r(bitcode_symbol_map_path, supporting_root)
                end
            end

            # `xcodebuild` action in fastlane does not support `-create-xcframework` arg yet.
            # Change it back to use fastlane action later when it is prepared.
            framework_args = frameworks.map { |framework_path| "-framework '#{framework_path}'"}
            args = "-create-xcframework #{framework_args.join(" ")} -output 'build/#{target_version}/#{scheme}/#{scheme}.xcframework'"
            Dir.chdir("..") do
                Action.sh "xcodebuild #{args}"
            end

            zip(
                path: "build/#{target_version}/#{scheme}",
                output_path: "build/#{scheme}-#{version}.zip"
            )
        end
    rescue => ex
        raise ex
    ensure
        FileUtils.mv(
            "../LineSDK/LineSDK.xcodeproj/xcshareddata/xcschemes/LineSDKObjCBinary.xcscheme",
            "../LineSDK/LineSDK.xcodeproj/xcshareddata/xcschemes/LineSDKObjCBinary.xcscheme.bak"
        )
        FileUtils.mv(
            "../LineSDK/LineSDK.xcodeproj/xcshareddata/xcschemes/LineSDKBinary.xcscheme",
            "../LineSDK/LineSDK.xcodeproj/xcshareddata/xcschemes/LineSDKBinary.xcscheme.bak"
        )
    end
  end
end
